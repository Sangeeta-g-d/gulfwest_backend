<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reset Password</title>
  <link rel="stylesheet" href="/static/assets/css/login.css">

  <!-- toastify link -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    .validation-list {
      text-align: left;
      font-size: 0.9rem;
      margin-top: 10px;
      padding-left: 20px;
    }
    .validation-list li {
      color: red;
    }
    .validation-list li.valid {
      color: green;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <h2>Reset Password</h2>

    <form method="POST" id="resetForm">
      {% csrf_token %}

      <label for="password1">New Password</label>
      <div class="password-wrapper">
        <input type="password" name="password1" id="password1" placeholder="Enter new password" required />
        <i class="fa-solid fa-eye" id="togglePassword1"></i>
      </div>

      <label for="password2">Confirm Password</label>
      <div class="password-wrapper">
        <input type="password" name="password2" id="password2" placeholder="Confirm new password" required />
        <i class="fa-solid fa-eye" id="togglePassword2"></i>
      </div>

      <ul class="validation-list" id="passwordRules">
        <li id="rule-length">At least 8 characters</li>
        <li id="rule-upper">At least 1 uppercase letter</li>
        <li id="rule-lower">At least 1 lowercase letter</li>
        <li id="rule-number">At least 1 number</li>
        <li id="rule-special">At least 1 special character (!@#$%^&*)</li>
        <li id="rule-match">Passwords must match</li>
      </ul>

      <button type="submit">Reset Password</button>
      <br>
      <a href="{% url 'login' %}" style="text-decoration: none;">Back to Login</a>
    </form>
  </div>

  <!-- Toastify -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
        var errorMessage = "{{ error_msg|escapejs }}";
        var successMessage = "{{ success_msg|escapejs }}";

        if (errorMessage.trim() !== "" && errorMessage !== "None") {
            Toastify({
                text: errorMessage,
                duration: 3000,
                close: true,
                gravity: "top",
                position: "center",
                backgroundColor: "#ff4d4d",
            }).showToast();
        }

        if (successMessage.trim() !== "" && successMessage !== "None") {
            Toastify({
                text: successMessage,
                duration: 3000,
                close: true,
                gravity: "top",
                position: "center",
                backgroundColor: "#28a745",
            }).showToast();
        }
    });
  </script>

  <!-- Password validation + toggle -->
  <script>
    const password1 = document.getElementById('password1');
    const password2 = document.getElementById('password2');

    const rules = {
      length: document.getElementById("rule-length"),
      upper: document.getElementById("rule-upper"),
      lower: document.getElementById("rule-lower"),
      number: document.getElementById("rule-number"),
      special: document.getElementById("rule-special"),
      match: document.getElementById("rule-match"),
    };

    function validatePassword() {
      const val1 = password1.value;
      const val2 = password2.value;

      rules.length.classList.toggle("valid", val1.length >= 8);
      rules.upper.classList.toggle("valid", /[A-Z]/.test(val1));
      rules.lower.classList.toggle("valid", /[a-z]/.test(val1));
      rules.number.classList.toggle("valid", /[0-9]/.test(val1));
      rules.special.classList.toggle("valid", /[!@#$%^&*]/.test(val1));
      rules.match.classList.toggle("valid", val1 && val1 === val2);
    }

    password1.addEventListener("input", validatePassword);
    password2.addEventListener("input", validatePassword);

    // Toggle visibility
    function togglePassword(field, icon) {
      icon.addEventListener("click", function () {
        const type = field.getAttribute("type") === "password" ? "text" : "password";
        field.setAttribute("type", type);
        this.classList.toggle("fa-eye-slash");
      });
    }
    togglePassword(password1, document.getElementById('togglePassword1'));
    togglePassword(password2, document.getElementById('togglePassword2'));

    // Prevent form submit if invalid
    document.getElementById("resetForm").addEventListener("submit", function (e) {
      validatePassword();
      const allValid = [...document.querySelectorAll(".validation-list li")].every(li => li.classList.contains("valid"));
      if (!allValid) {
        e.preventDefault();
        Toastify({
          text: "Please fix password requirements before submitting.",
          duration: 3000,
          close: true,
          gravity: "top",
          position: "center",
          backgroundColor: "#ff4d4d",
        }).showToast();
      }
    });
  </script>
</body>
</html>
